id: apiforgex-agent
namespace: dev.apiforgex
description: "The Autonomous Agent that builds, audits, and notifies."

inputs:
  - id: projectName
    type: STRING
    defaults: "kestra-generated-api"
    description: "The name of the folder/project to create"
  
  - id: database
    type: SELECT
    values: ["postgresql", "mysql", "mongodb"]
    defaults: "postgresql"
    description: "Target Database"

  - id: prompt
    type: STRING
    defaults: "A simple task management API with Users and Todos"
    description: "The natural language requirement"

  - id: slack_webhook
    type: STRING
    defaults: "https://hooks.slack.com/services/T000/B000/XXXX"
    description: "Slack Webhook URL for notifications"
    
  - id: github_token
    type: STRING
    defaults: "mock-token"
    description: "GitHub Personal Access Token (or 'mock-token' for test)"
    
  - id: github_user
    type: STRING
    defaults: "apiforgex-bot"
    description: "GitHub Username for the remote"

  - id: github_repo
    type: STRING
    defaults: "apiforgex-demo-output"
    description: "Target GitHub Repository Name"

  - id: vercel_token
    type: STRING
    defaults: "mock-token"
    description: "Vercel Deployment Token (or 'mock-token' for test)"

tasks:
  - id: log_start
    type: io.kestra.plugin.core.log.Log
    message: "ğŸš€ Starting ApiforgeX Agent for project: {{ inputs.projectName }}"

  - id: scaffold_code
    type: io.kestra.plugin.scripts.shell.Commands
    runner: PROCESS
    env:
      OLLAMA_HOST: "http://host.docker.internal:11434"
    commands:
      - "cd /app/projects/ApiforgeX"
      - "echo 'ğŸ—ï¸  Triggering CLI Generator...'"
      # Runs the local CLI we just built in the custom image environment
      - "npm install" # Ensure dependencies are installed/rebuilt for Linux
      - "npm start -- generate --name \"{{ inputs.projectName }}\" --db \"{{ inputs.database }}\" --prompt \"{{ inputs.prompt }}\""
    

  - id: create_and_push_branches
    type: io.kestra.plugin.scripts.shell.Commands
    runner: PROCESS
    commands:
      - "cd /app/projects/ApiforgeX/{{ inputs.projectName }}"
      # Git Config
      - "git config --global user.email 'bot@apiforgex.com'"
      - "git config --global user.name 'ApiforgeX Agent'"
      - "git config --global --add safe.directory '*'"
      
      # 1. Initialize and Push MAIN first (Empty State)
      - "git init"
      - "git branch -M main"
      - "git remote remove origin || true"
      - "git remote add origin https://oauth2:{{ inputs.github_token }}@github.com/{{ inputs.github_user }}/{{ inputs.github_repo }}.git"
      - "git commit --allow-empty -m 'chore: Initialize Repository'"
      - "echo 'ğŸš€ Pushing Clean Main Branch...'"
      - "git push -u origin main --force"

      # 2. Create and Push Feature Branch (With Code)
      - "git checkout -b feat/ai-update-{{ execution.startDate | date('yyyyMMddHHmmss') }}"
      - "git add ."
      - "git commit -m 'feat: Add generated backend code'"
      - "echo 'ğŸš€ Pushing Feature Branch...'"
      - "git push origin feat/ai-update-{{ execution.startDate | date('yyyyMMddHHmmss') }} --force"

  - id: open_automated_pr
    type: io.kestra.plugin.scripts.shell.Commands
    runner: PROCESS
    commands:
      - "echo 'ğŸ° Creating Pull Request via GitHub API...'"
      - |
        PR_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
          -H "Authorization: token {{ inputs.github_token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/{{ inputs.github_user }}/{{ inputs.github_repo }}/pulls \
          -d '{
            "title": "feat: AI Backend Generation ğŸš€",
            "body": "ğŸ¤– This code was auto-generated by ApiforgeX.\n\n**Reviewer:** @coderabbitai please review this.\n\ncc: @{{ inputs.github_user }}",
            "head": "feat/ai-update-{{ execution.startDate | date("yyyyMMddHHmmss") }}",
            "base": "main"
          }')
        
        echo "$PR_RESPONSE"
        
        # Check if PR was successful (Status 201)
        if echo "$PR_RESPONSE" | grep -q "HTTP_STATUS:201"; then
          echo "âœ… PR Created Successfully!"
        else
          echo "âš ï¸ PR Creation Failed. Check logs above."
          # Don't fail the flow, just warn
          exit 0 
        fi


  - id: deploy_vercel
    type: io.kestra.plugin.scripts.shell.Commands
    runner: PROCESS
    commands:
      - "cd /app/projects/ApiforgeX"
      - "echo 'ğŸš€ Deploying to Vercel...'"
      - "cd {{ inputs.projectName }}"
      - |
        if echo '{{ inputs.vercel_token }}' | grep -q 'mock-token'; then
          echo 'âš ï¸ Mock Mode: Skipping Vercel Deployment'
        else
          VERCEL_OUT_FILE=$(mktemp)
          npx vercel deploy --prod --token {{ inputs.vercel_token }} --yes 2>&1 | tee $VERCEL_OUT_FILE
          VERCEL_DEPLOY_URL=$(grep -o 'https://[^ ]*\.vercel\.app' $VERCEL_OUT_FILE | tail -1)
          VERCEL_LIVE_URL="https://{{ inputs.projectName }}.vercel.app"
          echo "ğŸ”— Captured Build URL: $VERCEL_DEPLOY_URL"
          echo "ğŸ”— Live Link: $VERCEL_LIVE_URL"
          curl -X POST -H "Content-type: application/json" --data "{ \"text\": \"âœ… *Mission Complete!*\\nğŸš€ Project: {{ inputs.projectName }}\\nğŸ“š Database: {{ inputs.database }}\\nâœ¨ Status: Deployed & Audited.\\nğŸ”— Vercel: $VERCEL_LIVE_URL\\nğŸ”— GitHub PR: https://github.com/{{ inputs.github_user }}/{{ inputs.github_repo }}/pull/1\" }" {{ inputs.slack_webhook }}
        fi

  - id: notify_success
    type: io.kestra.plugin.core.log.Log
    message: "âœ… Mission Complete! Notifications sent."

errors:
  - id: notify_failure
    type: io.kestra.plugin.scripts.shell.Commands
    runner: PROCESS
    commands:
      - echo "âŒ ApiforgeX Failed on project {{ inputs.projectName }}."
      - |
        curl -X POST -H "Content-type: application/json" --data "{
          \"text\": \"âŒ *ApiforgeX Failed* on project {{ inputs.projectName }}.\\nCheck Kestra logs for details.\"
        }" {{ inputs.slack_webhook }}